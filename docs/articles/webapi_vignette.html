<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebAPI functionality • ecmwfr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="WebAPI functionality">
<meta property="og:description" content="ecmwfr">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ecmwfr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ads_vignette.html">ADS functionality</a>
    </li>
    <li>
      <a href="../articles/advanced_vignette.html">Advanced Use Cases</a>
    </li>
    <li>
      <a href="../articles/cds_vignette.html">CDS functionality</a>
    </li>
    <li>
      <a href="../articles/webapi_vignette.html">WebAPI functionality</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bluegreen-labs/ecmwfr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="webapi_vignette_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>WebAPI functionality</h1>
                        <h4 class="author">Koen Hufkens</h4>
            
            <h4 class="date">2021-10-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bluegreen-labs/ecmwfr/blob/master/vignettes/webapi_vignette.Rmd"><code>vignettes/webapi_vignette.Rmd</code></a></small>
      <div class="hidden name"><code>webapi_vignette.Rmd</code></div>

    </div>

    
    
<div id="ecmwfr" class="section level1">
<h1 class="hasAnchor">
<a href="#ecmwfr" class="anchor"></a>ecmwfr</h1>
<p>Programmatic interface to the <a href="https://confluence.ecmwf.int/display/WEBAPI/ECMWF+Web+API+Home">‘ECMWF’ web API services</a>. Allows for easy downloads of ECMWF <a href="https://confluence.ecmwf.int/display/WEBAPI/Access+ECMWF+Public+Datasets">public data</a>.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>Before starting save your provided ECMWF key to your local keychain. In this example I use my R development account with the key hidden using Xs. The package does not allow you to use your key inline in scripts to limit security issues when sharing scripts on github or otherwise.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set a key to the keychain</span>
<span class="fu"><a href="../reference/wf_set_key.html">wf_set_key</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"khrdev@outlook.com"</span>,
           key <span class="op">=</span> <span class="st">"XXXXXXXXXXXXXXXXXXXXXX"</span>,
           service <span class="op">=</span> <span class="st">"webapi"</span><span class="op">)</span>

<span class="co"># you can retrieve the key using</span>
<span class="fu"><a href="../reference/wf_get_key.html">wf_get_key</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"khrdev@outlook.com"</span><span class="op">)</span>

<span class="co"># the output should be the key you provided</span>
<span class="co"># in this case represented by the fake X string.</span>
<span class="co"># "XXXXXXXXXXXXXXXXXXXXXX"</span></code></pre></div>
<p>Alternatively, you can call the <code><a href="../reference/wf_set_key.html">wf_set_key()</a></code> function with only the service argument. The function will then redirect you to the correct login page where you can find your login credentials, which can be copied and pasted into the command prompt.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set a key to the keychain</span>
<span class="fu"><a href="../reference/wf_set_key.html">wf_set_key</a></span><span class="op">(</span>service <span class="op">=</span> <span class="st">"webapi"</span><span class="op">)</span></code></pre></div>
<p>Before you can download any data you have to make sure to accept the terms and conditions here: <a href="https://apps.ecmwf.int/datasets/licences/general/">https://apps.ecmwf.int/datasets/licences/general/</a>.</p>
</div>
<div id="ecmwf-data-requests-public-data-sets" class="section level2">
<h2 class="hasAnchor">
<a href="#ecmwf-data-requests-public-data-sets" class="anchor"></a>ECMWF Data Requests (Public Data Sets)</h2>
<p>To download data use the <code><a href="../reference/wf_request.html">wf_request()</a></code> function, together with your email and a request string syntax <a href="https://confluence.ecmwf.int/display/WEBAPI/Brief+request+syntax#Briefrequestsyntax-Syntax">as documented</a>. Instead of <code>json</code> formatting the function uses a simple <code>R</code> list for all the arguments.</p>
<p>The conversion from a MARS or python based query to the list format can be automated if you use the RStudio based Addin. By selecting and using Addin -&gt; Mars to list (or ‘Python to list’) you dynamically convert queries copied from either ECMWF or CDS based services.</p>
<p><img src="https://user-images.githubusercontent.com/1354258/56429601-ced94100-62c3-11e9-82f3-ae2cd03d06f5.gif"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># this is an example of a request</span>
<span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>stream  <span class="op">=</span> <span class="st">"oper"</span>,
                   levtype <span class="op">=</span> <span class="st">"sfc"</span>,
                   param   <span class="op">=</span> <span class="st">"167.128"</span>,
                   dataset <span class="op">=</span> <span class="st">"interim"</span>,
                   step    <span class="op">=</span> <span class="st">"0"</span>,
                   grid    <span class="op">=</span> <span class="st">"0.75/0.75"</span>,
                   time    <span class="op">=</span> <span class="st">"00"</span>,
                   date    <span class="op">=</span> <span class="st">"2014-07-01/to/2014-07-02"</span>,
                   type    <span class="op">=</span> <span class="st">"an"</span>,
                   class   <span class="op">=</span> <span class="st">"ei"</span>,
                   area    <span class="op">=</span> <span class="st">"73.5/-27/33/45"</span>,
                   format  <span class="op">=</span> <span class="st">"netcdf"</span>,
                   target  <span class="op">=</span> <span class="st">"tmp.nc"</span><span class="op">)</span>

<span class="co"># an example download using fw_request()</span>
<span class="co"># using the above request list()</span>
<span class="va">ncfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wf_request.html">wf_request</a></span><span class="op">(</span>user    <span class="op">=</span> <span class="st">"khrdev@outlook.com"</span>,
           request  <span class="op">=</span> <span class="va">request</span>,
           transfer <span class="op">=</span> <span class="cn">TRUE</span>,
           path     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>,
           verbose  <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>The download operation might take a while. A progress indicator will keep you informed on the status of your request. The download will expire after a default time out of one hour. You will be informed of where to track your job request on <a href="https://apps.ecmwf.int/webmars/joblist/">the ECMWF website</a>, and provided with a download url which can be used with the <code>wt_transfer()</code> funtion to download the data on a later moment. Keep in mind that you can only have 3 active downloads and 20 job items queued!</p>
<p>If the download is successful you can visualize one layer in the retrieved stack of temperatures at 2 meters using the plotting routine below.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">ncfile</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>
<span class="co">#&gt; class      : RasterStack </span>
<span class="co">#&gt; dimensions : 55, 97, 5335, 1  (nrow, ncol, ncell, nlayers)</span>
<span class="co">#&gt; resolution : 0.75, 0.75  (x, y)</span>
<span class="co">#&gt; extent     : -27.375, 45.375, 32.625, 73.875  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; crs        : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 </span>
<span class="co">#&gt; names      :    layer </span>
<span class="co">#&gt; min values : 268.5063 </span>
<span class="co">#&gt; max values : 305.4419</span>

<span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"2 meter temperature (Kelvin)"</span><span class="op">)</span>
<span class="fu">maps</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html">map</a></span><span class="op">(</span><span class="st">"world"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="webapi_vignette_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
</div>
<div id="ecmwf-mars-requests" class="section level2">
<h2 class="hasAnchor">
<a href="#ecmwf-mars-requests" class="anchor"></a>ECMWF mars Requests</h2>
<p>The <code>ecmwfr</code> package (<a href="../references/wf_request.html"><code>wf_request()</code></a>) also allows to submit <em>mars</em> requests. Note that this requires a member state login or a commercial user account!</p>
<p>The <code>ecmwfr</code> syntax for <em>mars</em> requests is identical to the ones to the public ECMWF API except that one has to specify <code>dataset = "mars"</code>. The example below downloads the 2 meter temperature forecast (parameter <code>167</code>) from the 00 UTC ECMWF HRES run January 22, 2019, only 12 ahead forecast (<code>step</code>). A NetCDF file with a regular <code>0.125 x 0.125</code> degree horizontal resolution for a custom area in northern Europe will be downloaded (<code>area</code>). <strong>Note</strong> that the <code>grid</code> specification <em>is required</em> if <code>format = "netcdf"</code> as grib to NetCDF conversion is only able for regular longitude-latitude grids.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># this is an example of a request</span>
<span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"dataset"</span> <span class="op">=</span> <span class="st">"mars"</span>,
                   <span class="st">"class"</span>   <span class="op">=</span> <span class="st">"od"</span>,
                   <span class="st">"date"</span>    <span class="op">=</span> <span class="st">"2019-01-22"</span>,
                   <span class="st">"expver"</span>  <span class="op">=</span> <span class="st">"1"</span>,
                   <span class="st">"levtype"</span> <span class="op">=</span> <span class="st">"sfc"</span>,
                   <span class="st">"param"</span>   <span class="op">=</span> <span class="st">"167.128"</span>,
                   <span class="st">"step"</span>    <span class="op">=</span> <span class="st">"0"</span>,
                   <span class="st">"stream"</span>  <span class="op">=</span> <span class="st">"oper"</span>,
                   <span class="st">"time"</span>    <span class="op">=</span> <span class="st">"12"</span>,
                   <span class="st">"type"</span>    <span class="op">=</span> <span class="st">"fc"</span>,
                   <span class="st">"grid"</span>    <span class="op">=</span> <span class="st">"0.125/0.125"</span>,
                   <span class="st">"area"</span>    <span class="op">=</span> <span class="st">"50/0/30/15"</span>,
                   <span class="st">"format"</span>  <span class="op">=</span> <span class="st">"netcdf"</span>,
                   <span class="st">"target"</span>  <span class="op">=</span> <span class="st">"mars-data.nc"</span><span class="op">)</span>

<span class="co"># Submit mars request and wait for netcdf file</span>
<span class="fu"><a href="../reference/wf_request.html">wf_request</a></span><span class="op">(</span>user    <span class="op">=</span> <span class="st">"khrdev@outlook.com"</span>,
           transfer <span class="op">=</span> <span class="cn">TRUE</span>,
           path     <span class="op">=</span> <span class="st">"~"</span>,
           request  <span class="op">=</span> <span class="va">request</span>,
           verbose  <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="listing-ancillary-data" class="section level2">
<h2 class="hasAnchor">
<a href="#listing-ancillary-data" class="anchor"></a>Listing Ancillary data</h2>
<p>You can list ancillary data such as user information, datasets and services using the following calls.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># user info</span>
<span class="va">user_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wf_user_info.html">wf_user_info</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"khrdev@outlook.com"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">user_info</span><span class="op">)</span>

<span class="co"># services</span>
<span class="va">services</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wf_services.html">wf_services</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"khrdev@outlook.com"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">services</span><span class="op">)</span>

<span class="co"># datasets</span>
<span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wf_datasets.html">wf_datasets</a></span><span class="op">(</span>user <span class="op">=</span> <span class="st">"khrdev@outlook.com"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Koen Hufkens, BlueGreen Labs.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
